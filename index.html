<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Sticker Converter</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <style>
        :root { --whatsapp: #25D366; --dark: #0b141a; --card: #111b21; --text: #e9edef; }
        body { font-family: sans-serif; background: var(--dark); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: var(--card); padding: 30px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .drop-zone { border: 2px dashed #3b4a54; border-radius: 10px; padding: 30px; margin: 20px 0; cursor: pointer; }
        .btn { background: var(--whatsapp); color: white; border: none; padding: 12px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; text-decoration: none; display: inline-block; box-sizing: border-box; }
        .btn:disabled { background: #3b4a54; }
        #progress-container { display: none; margin-top: 20px; }
        .bar { height: 8px; background: #2a3942; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .fill { height: 100%; background: var(--whatsapp); width: 0%; transition: 0.3s; }
        #timer { color: #ff5e5e; font-size: 14px; margin-top: 15px; display: none; }
        video { width: 100%; border-radius: 8px; display: none; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Sticker Maker 1MB</h2>
    <p>Converte vídeos em figurinhas WebP</p>

    <div class="drop-zone" id="drop-zone">
        <video id="preview" controls></video>
        <span id="label">Clique para selecionar vídeo</span>
        <input type="file" id="file-input" accept="video/*" hidden>
    </div>

    <button id="convert-btn" class="btn" disabled>Converter Agora</button>

    <div id="progress-container">
        <span id="status">Carregando processador...</span>
        <div class="bar"><div class="fill" id="fill"></div></div>
    </div>

    <div id="result-area" style="margin-top: 20px;"></div>
    <p id="timer"></p>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: false });
    
    const fileInput = document.getElementById('file-input');
    const convertBtn = document.getElementById('convert-btn');
    const status = document.getElementById('status');
    const fill = document.getElementById('fill');
    const timerText = document.getElementById('timer');

    // Inicializa o motor
    (async () => {
        try {
            await ffmpeg.load();
            status.innerText = "Motor pronto!";
        } catch (e) {
            status.innerText = "Erro. Recarregue a página.";
        }
    })();

    document.getElementById('drop-zone').onclick = () => fileInput.click();

    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const preview = document.getElementById('preview');
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
            document.getElementById('label').style.display = 'none';
            convertBtn.disabled = false;
        }
    };

    convertBtn.onclick = async () => {
        const file = fileInput.files[0];
        document.getElementById('progress-container').style.display = 'block';
        convertBtn.disabled = true;

        ffmpeg.setProgress(({ ratio }) => {
            fill.style.width = (ratio * 100) + '%';
            status.innerText = `Convertendo: ${Math.round(ratio * 100)}%`;
        });

        ffmpeg.FS('writeFile', 'input', await fetchFile(file));

        // Comando otimizado para < 1MB: 512px, 12fps, qualidade média
        await ffmpeg.run(
            '-i', 'input',
            '-t', '5.5', // WhatsApp corta em ~6s
            '-vf', 'fps=12,scale=512:512:force_original_aspect_ratio=increase,crop=512:512',
            '-qscale', '50', 
            '-loop', '0',
            'output.webp'
        );

        const data = ffmpeg.FS('readFile', 'output.webp');
        const url = URL.createObjectURL(new Blob([data.buffer], { type: 'image/webp' }));

        const resArea = document.getElementById('result-area');
        resArea.innerHTML = `<a href="${url}" download="sticker.webp" class="btn">BAIXAR FIGURINHA</a>`;
        
        startTimer(20, url);
    };

    function startTimer(mins, url) {
        let time = mins * 60;
        timerText.style.display = 'block';
        const itv = setInterval(() => {
            let m = Math.floor(time / 60);
            let s = time % 60;
            timerText.innerText = `O link expira em ${m}:${s < 10 ? '0' : ''}${s}. A página irá resetar.`;
            if (time <= 0) {
                clearInterval(itv);
                URL.revokeObjectURL(url);
                location.reload();
            }
            time--;
        }, 1000);
    }
</script>

</body>
</html>
